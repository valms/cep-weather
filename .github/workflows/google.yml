name: Deploy to Cloud Run

on:
    push:
        branches:
            - master

env:
    PROJECT_ID: fullcycle-p
    SERVICE_NAME: cep-weather-api
    REGION: northamerica-northeast1
    APP_NAME: cep-weather-api

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   id: 'auth'
                uses: 'google-github-actions/auth@v2'
                with:
                    credentials_json: '${{ secrets.GCP_SA_KEY }}'

            -   name: 'Set up Cloud SDK'
                uses: 'google-github-actions/setup-gcloud@v2'

            -   name: Authorize Docker push
                run: gcloud auth configure-docker northamerica-northeast1-docker.pkg.dev

            -   name: Build and push Docker image
                run: |
                    docker build . --tag ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ env.APP_NAME }}:${{ github.sha }}
                    docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ env.APP_NAME }}:${{ github.sha }}

            - name: Deploy to Cloud Run
              run: |
                  gcloud run deploy ${{ env.SERVICE_NAME }} \
                    --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ env.APP_NAME }}:${{ github.sha }} \
                    --platform managed \
                    --region ${{ env.REGION }} \
                    --allow-unauthenticated \
                    --set-env-vars "API_KEY=${{ secrets.WEATHER_API_KEY }}"

            -   name: Clean up old images
                run: gcloud artifacts docker images delete ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ env.APP_NAME }} --quiet

            -   name: Show Output
                run: echo ${{ steps.deploy.outputs.url }}
